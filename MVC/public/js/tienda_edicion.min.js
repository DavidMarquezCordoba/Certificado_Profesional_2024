let carrito=[];let textoCarrito='';let botonCerrarModal,botonModificar,modalContenido,fotoProducto,botonEliminar,botonNuevo;document.addEventListener("DOMContentLoaded",function(){botonCerrarModal=document.querySelectorAll(".close");modalContenido=document.querySelector("#modal-contenido");fotoProducto=document.querySelector("#detalle-imagen");botonModificar=document.querySelector("#detalle-Modificar");botonEliminar=document.querySelector("#detalle-Eliminar");botonNuevo=document.querySelector(".boton-nuevo");fotoProducto.addEventListener("click",e=>{document.querySelector("#imagen-input").click()});botonModificar.addEventListener("click",enviaEdicionProducto);botonEliminar.addEventListener("click",enviaEdicionProducto);botonNuevo.addEventListener("click",fichaProducto)});function verDetalles(e){if(e.target.id!="productos-contenedor"){const producto=e.target.closest(".producto");mostrarDetalle(producto.dataset.codigo_barras)}}
function mostrarDetalle(producto){mostrarLoader();console.log(producto);let url=`/api/productos?detalles=${producto}`;fetch(url,{headers:{'token':mikey}}).then(response=>{try{return response.json()}catch(e){return[]}}).then(detallesProducto=>{fichaProducto(detallesProducto)}).catch(error=>{alerta('Error al cargar los detalles del producto')}).finally(()=>{ocultarLoader()})}
function fichaProducto(datosProducto=[]){document.querySelector("#detalle-nombre").value=datosProducto.nombre??'';document.querySelector("#detalle-imagen").src=datosProducto.foto??'img/avatares/youngpeople.png';document.querySelector("#detalle-precio").value=datosProducto.precio??'1';document.querySelector("#detalle-categoria").value=datosProducto.categoriaId??'1';document.querySelector("#detalle-genero").value=datosProducto.generoId??'1';document.querySelector("#detalle-unidades").value=datosProducto.unidades_disponibles??'0';document.querySelector("#detalle-codigo").value=datosProducto.codigo_barras??'';document.querySelector("#detalle-codigo-oculto").value=datosProducto.codigo_barras??'';document.querySelector("#detalle-descripcion").textContent=datosProducto.descripcion??'';modalContenido.classList.add("abrir-modal");modal.classList.add("abrir-modal-fondo");modal.style.display="flex";document.body.classList.add("para-scroll");setTimeout(()=>{modal.classList.remove("abrir-modal-fondo");modalContenido.classList.remove("abrir-modal")},500)}
async function enviaEdicionProducto(e){e.preventDefault();var archivoImagen=document.querySelector('input[type="file"]');const formulario=document.querySelector("#modal-contenido");const inputs=formulario.querySelectorAll("[name]");const datos=new FormData();if(archivoImagen.files[0]){datos.append('miimagen',archivoImagen.files[0]);console.log("si hay imagen")}else{console.log("NO hay imagen")}
datos.append("acc",e.target.dataset.acc);inputs.forEach((valor)=>{datos.append(valor.name,valor.value)});try{const url=formulario.getAttribute("action");const response=await fetch(url,{headers:{'token':mikey},method:'POST',body:datos});let datosRecibido=await response.json();if(datosRecibido['ok']){mensaje(datosRecibido['mensaje'],"/tienda")}else{alerta("No podido actualizar los datos del producto: "+datosRecibido['error'])}}catch(error){console.log(error);alerta('Error al contactar con el servidor')}}
function previsualizaImagen(){const imagenInput=document.querySelector('#imagen-input');const imagenProducto=document.querySelector('#detalle-imagen');const imagenNueva=imagenInput.files[0];if(imagenNueva){const imagenNuevaLeida=new FileReader();imagenNuevaLeida.onload=function(e){imagenProducto.src=e.target.result};imagenNuevaLeida.readAsDataURL(imagenNueva)}}