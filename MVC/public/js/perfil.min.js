let botonOjo,fotoPerfil;document.addEventListener("DOMContentLoaded",function(){botonOjo=document.querySelectorAll(".div-pass label")??[];botonActualiza=document.querySelector("#actualiza-perfil");botonCerrarSesion=document.querySelector("#cerrar-sesion");fotoPerfil=document.querySelector("#imagen-perfil");botonOjo.forEach(miboton=>{miboton.addEventListener("click",conmutaOjo)});botonActualiza.addEventListener("click",actualizaPerfil);botonCerrarSesion.addEventListener("click",cierraSesion);fotoPerfil.addEventListener("click",e=>{document.querySelector("#imagen-input").click()})});function conmutaOjo(e){const miSelector="#"+e.target.id+"+input";const miinput=document.querySelector(miSelector);if(miinput.getAttribute("type").toLocaleLowerCase()!="text"){miinput.setAttribute("type","text");e.target.innerHTML="&#128512;"}else{miinput.setAttribute("type","password");e.target.innerHTML="&#129763;"}}
function previsualizaImagen(){const imagenInput=document.querySelector('#imagen-input');const imagenPerfil=document.querySelector('#imagen-perfil');const imagenNueva=imagenInput.files[0];if(imagenNueva){const imagenNuevaLeida=new FileReader();imagenNuevaLeida.onload=function(e){imagenPerfil.src=e.target.result};imagenNuevaLeida.readAsDataURL(imagenNueva)}}
async function cierraSesion(){try{const respuesta=await fetch("/api/logout",{method:'POST',headers:{'token':mikey}});let datosRecibido=await respuesta.json();if(datosRecibido['ok']){mensaje(datosRecibido['mensaje'],"/")}else{alerta("No podido cerrar la sesión")}
console.log(datosRecibido)}catch(error){alerta('Error al contactar:'+error)}}
function actualizaPerfil(event){event.preventDefault();const nombre=document.querySelector('#nombre').value;const email=document.querySelector('#email').value;const passAntigua=document.querySelector('#pass-antigua').value;const passNueva=document.querySelector('#pass-nueva').value;const passConfirma=document.querySelector('#pass-confirma').value;if(nombre.length==0){alerta("Necesitas introducir un nombre de usuario para realizar alguna modificación.");return}
if(passAntigua.length<8){alerta("Necesitas la contraseña para realizar alguna modificación.");return}
if(passNueva.length>0){if(passNueva!==passConfirma){alerta("Las contraseñas nuevas no coinciden.");return}
if(passNueva.length<8){alerta("La nueva contraseña debe tener al menos 8 caracteres.");return}}
EnviaActualizacion()}
async function EnviaActualizacion(){var archivoImagen=document.querySelector('input[type="file"]');const formulario=document.querySelector("#formulario-perfil");const inputs=formulario.querySelectorAll("input");const datos=new FormData();if(archivoImagen.files[0]){datos.append('miimagen',archivoImagen.files[0]);console.log("si hay imagen")}else{console.log("NO hay imagen")}
inputs.forEach((valor)=>{datos.append(valor.name,valor.value)});try{const url=formulario.getAttribute("action");const response=await fetch(url,{headers:{'token':mikey},method:'POST',body:datos});const datosStr=await response.clone().text();console.log("recibido:"+datosStr);let datosRecibido=await response.json();if(datosRecibido['ok']){mensaje(datosRecibido['mensaje'],"/perfil")}else{alerta("No podido actualizar los datos de perfil: "+datosRecibido['error'])}}catch(error){console.log(error);alerta('Error al contactar con el servidor')}}